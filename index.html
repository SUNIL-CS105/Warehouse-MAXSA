<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>MAXSA Warehouse Map with Firebase</title>
  <script src="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack-all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/gridstack@8.2.1/dist/gridstack.min.css" rel="stylesheet"/>
  <script type="module">
    // Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDgTBFlnjtcbdvuf2l7YUnoHXK9-L4I5MI",
      authDomain: "warehouse-maxsa.firebaseapp.com",
      projectId: "warehouse-maxsa",
      storageBucket: "warehouse-maxsa.firebasestorage.app",
      messagingSenderId: "978214247804",
      appId: "1:978214247804:web:aa785914ee177d74ba98f9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const grid = GridStack.init({ float: true, cellHeight: 80, column: 25, minRow: 30 });

    function createPalletElement(id, item, qty, x = 1, y = 25) {
      const el = document.createElement('div');
      el.classList.add('grid-stack-item');
      el.setAttribute('gs-x', x);
      el.setAttribute('gs-y', y);
      el.setAttribute('gs-width', 1);
      el.setAttribute('gs-height', 1);
      el.setAttribute('data-id', id);

      el.innerHTML = `
        <div class="grid-stack-item-content pallet-box" style="background:red;color:white;border:2px solid black;">
          <div><strong>${item}</strong></div>
          <div>Qty: ${qty}</div>
          <div class="control-btns">
            <button class="btn" onclick="splitPallet('${id}', '${item}', ${qty})">Split</button>
            <button class="btn" onclick="removePallet('${id}', this)">Ship</button>
          </div>
        </div>`;
      grid.addWidget(el);
    }

    window.splitPallet = async function(id, item, qty) {
      const newQty = prompt("Enter quantity for new split pallet", Math.floor(qty/2));
      if (!isNaN(newQty) && newQty > 0 && newQty < qty) {
        // Reduce original quantity in Firestore
        await deleteDoc(doc(db, "pallets", id));
        await addDoc(collection(db, "pallets"), { item, qty: qty - newQty });
        await addDoc(collection(db, "pallets"), { item, qty: parseInt(newQty) });
        location.reload();
      }
    };

    window.removePallet = async function(id, btn) {
      await deleteDoc(doc(db, "pallets", id));
      const box = btn.closest('.grid-stack-item');
      grid.removeWidget(box);
    };

    window.spawnNewPallet = async function () {
      const item = document.getElementById('new-item').value.trim();
      const qty = parseInt(document.getElementById('new-qty').value.trim());
      if (!item || isNaN(qty) || qty <= 0) {
        alert("Please enter valid item and quantity");
        return;
      }
      await addDoc(collection(db, "pallets"), { item, qty });
      document.getElementById('new-item').value = '';
      document.getElementById('new-qty').value = '';
      location.reload();
    };

    window.calculateTotals = async function () {
      const snapshot = await getDocs(collection(db, "pallets"));
      const totals = {};
      snapshot.forEach(doc => {
        const d = doc.data();
        totals[d.item] = (totals[d.item] || 0) + d.qty;
      });
      let summaryHTML = '<h4>Total Remaining Quantities:</h4><ul>';
      for (let item in totals) {
        summaryHTML += `<li>${item}: ${totals[item]}</li>`;
      }
      summaryHTML += '</ul>';
      document.getElementById('summary-box').innerHTML = summaryHTML;
    };

    async function loadPallets() {
      const snapshot = await getDocs(collection(db, "pallets"));
      snapshot.forEach(doc => {
        const d = doc.data();
        createPalletElement(doc.id, d.item, d.qty);
      });
    }

    window.onload = () => loadPallets();
  </script>
  <style>
    body { font-family: Arial; background: #f5f5f5; margin: 0; padding: 1rem; }
    h2 { margin-top: 0; }
    .grid-stack { background: #fff; border: 2px solid #ccc; height: 85vh; position: relative; }
    .grid-stack-item-content {
      background: #ffeb3b;
      color: black;
      border: 1px solid #333;
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 5px;
      font-size: 12px;
      overflow: hidden;
    }
    .btn { font-size: 10px; padding: 2px 4px; cursor: pointer; background: #444; color: #fff; border: none; border-radius: 3px; margin: 2px 0; }
    .btn:hover { background: #000; }
    #add-product-panel {
      margin-bottom: 1rem;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #summary-box {
      background: #eee;
      padding: 10px;
      margin-top: 1rem;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <h2>MAXSA Warehouse Map</h2>
  <div id="add-product-panel">
    <input type="text" id="new-item" placeholder="New Item #">
    <input type="number" id="new-qty" placeholder="Quantity">
    <button class="btn" onclick="spawnNewPallet()">âž• Add New Product</button>
    <button class="btn" onclick="calculateTotals()">ðŸ“Š Get Inventory Summary</button>
  </div>
  <div class="grid-stack"></div>
  <div id="summary-box"></div>
</body>
</html>
