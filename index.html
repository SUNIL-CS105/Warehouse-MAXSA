<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.9" />
  <title>MAXSA Warehouse Map with Resizable Pallets</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <style>
    body { font-family: Arial; background: #f5f5f5; margin:0; padding:1rem; }
    h2 { margin-top: 0; }
    .grid-stack {
      position: relative;
      width: 1730px;
      height: 1350px;
      background: #ADD8E6;
      border: 2px solid #000000;
      user-select: none;
      contain: strict; /* Improves rendering performance */
    }
    .label-cell {
      position: absolute;
      border: 1px solid #000000;
      text-align: center;
      padding: 5px;
      font-size: 12px;
      background-color: #FFFFFF;
      box-sizing: border-box;
      pointer-events: none; /* Let pallets handle events */
    }
    .office-zone, .restroom-zone, .drop-zone {
      font-weight: bold;
    }
    .office-zone {
      background-color: #FFFFFF;
    }
    .restroom-zone {
      background-color: #FFFFFF;
    }
    .drop-zone {
      border: 2px dashed white;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: default;
    }
    .drop-zone#SHIPPED {
      background-color: #e74c3c;
    }
    .drop-zone#TO-8412-OFFICE {
      background-color: #2980b9;
    }
    .pallet {
      position: absolute;
      background: orange;
      color: black;
      font-weight: bold;
      border: 2px solid #000000;
      text-align: center;
      cursor: grab;
      user-select: none;
      box-sizing: border-box;
      padding: 4px 2px 10px 2px;
      font-size: 12px;
      white-space: pre-line;
      will-change: transform; /* Improves drag performance */
      backface-visibility: hidden;
      transform: translateZ(0);
    }
    .pallet.dragging {
      opacity: 0.6;
      cursor: grabbing;
      z-index: 1000;
    }
    .split-arrow {
      position: absolute;
      top: 2px;
      right: 4px;
      background: black;
      color: white;
      font-weight: bold;
      font-size: 14px;
      width: 18px;
      height: 18px;
      line-height: 18px;
      border-radius: 3px;
      cursor: pointer;
      user-select: none;
      z-index: 10;
    }
    #add-product-panel {
      position: absolute;
      top: 650px;
      left: 1000px;
      background: #27ae60;
      padding: 10px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      width: 200px;
      box-sizing: border-box;
    }
    #add-product-panel input {
      width: calc(100% - 12px);
      margin-bottom: 6px;
      padding: 5px;
      border: none;
      border-radius: 3px;
      font-size: 14px;
    }
    #add-product-panel input::placeholder {
      color: #bbb;
    }
    #add-product-panel button {
      width: 100%;
      padding: 6px;
      font-weight: bold;
      font-size: 14px;
      background: #2ecc71;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      color: white;
    }
    #add-product-panel button:hover {
      background: #27ae60;
    }
    #inventory-summary-panel {
      position: absolute;
      top: 80px;
      left: 1480px;
      background: #3498db;
      padding: 10px;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      width: 220px;
      box-sizing: border-box;
      font-size: 14px;
      cursor: pointer;
      text-align: center;
      user-select: none;
    }
    #inventory-summary-output {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 6px;
      font-weight: normal;
      font-size: 13px;
      background: rgba(255 255 255 / 0.2);
      padding: 6px;
      border-radius: 4px;
      text-align: left;
      white-space: nowrap;
    }
    /* Login styles */
    #login-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: white;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .login-box {
      background: #f5f5f5;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      width: 300px;
    }
    .login-box input {
      width: 100%;
      padding: 0.5rem;
      margin: 0.5rem 0;
      box-sizing: border-box;
    }
    .login-box button {
      width: 100%;
      padding: 0.5rem;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1rem;
    }
    #logout-btn {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 0.5rem 1rem;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: none;
      z-index: 1001;
    }
    #loading-indicator {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 1.5rem;
      z-index: 1002;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Login UI -->
  <div id="login-container">
    <div class="login-box">
      <h2>Warehouse Login</h2>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="password" placeholder="Password">
      <button id="login-btn">Login</button>
    </div>
  </div>

  <!-- Loading Indicator -->
  <div id="loading-indicator">Loading warehouse data...</div>

  <!-- Logout Button -->
  <button id="logout-btn">Logout</button>

  <!-- Main Warehouse App -->
  <div id="warehouse-app" style="display:none;">
    <h2>MAXSA Warehouse Map</h2>
    <div class="grid-stack"></div>

    <div id="add-product-panel">
      <input type="text" id="new-item" placeholder="Item #" />
      <input type="number" id="new-q" placeholder="Quantity" min="1" />
      <button id="add-product-btn">âž• Add New Product</button>
    </div>

    <div id="inventory-summary-panel" title="Show total quantities of all products (excluding shipped and To 8412 Office)">
      ðŸ“Š Show Inventory Summary
      <div id="inventory-summary-output" style="display:none;"></div>
    </div>
  </div>

  <script>
    // --- Firebase Configuration ---
    const firebaseConfig = {
    apiKey: "AIzaSyDgTBFlnjtcbdvuf2l7YUnoHXK9-L4I5MI",
    authDomain: "warehouse-maxsa.firebaseapp.com",
    databaseURL: "https://warehouse-maxsa-default-rtdb.firebaseio.com",
    projectId: "warehouse-maxsa",
    storageBucket: "warehouse-maxsa.firebasestorage.app",
    messagingSenderId: "978214247804",
    appId: "1:978214247804:web:aa785914ee177d74ba98f9"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    database.ref('.info/connected').on('value', (snapshot) => {
    if (snapshot.val() === true) {
    console.log("Firebase connection optimized");
    }
    });

    // --- Warehouse App Variables ---
    const CELL_WIDTH = 80;
    const CELL_HEIGHT = 50;
    let pallets = []; // array of pallet objects
    let palletsByLocation = {}; // key = location name, value = array of pallets

    // Location definitions
    const locations = {
      gridLabels: {
        rows: ['X','W','V','U','T','S','R','Q','P','O','N','M','L','K','J','I','H','G','F','E','D','C','B','A'],
        cols: 11
      },
      offices: {
        count: 30,
        startLeft: 980,
        startTop: 0,
        cols: 6,
        cellWidth: 80,
        cellHeight: 50
      },
      restroomsShelvesTemp: [
        { name: 'Restroom1', left: 980, top: 300 },
        { name: 'Restroom2', left: 1060, top: 300 },
        { name: 'Shelf1', left: 1220, top: 300 },
        { name: 'Shelf2', left: 1300, top: 300 },
        { name: 'Shelf3', left: 1380, top: 300 },
        { name: 'Shelf4', left: 1220, top: 350 },
        { name: 'Shelf5', left: 1300, top: 350 },
        { name: 'Shelf6', left: 1380, top: 350 },
        { name: 'New_#', left: 990, top: 500, width: 160, height: 80, color: '#FFFFFF' },
        { name: 'Temporary1', left: 980, top: 850 },
        { name: 'Temporary2', left: 980, top: 900 },
        { name: 'Temporary3', left: 980, top: 950 },
        { name: 'Temporary4', left: 980, top: 1000 },
        { name: 'Temporary5', left: 980, top: 1050 },
        { name: 'Temporary6', left: 980, top: 1100 },
        { name: 'Temporary7', left: 980, top: 1150 },
        { name: 'Temporary8', left: 1070, top: 850 },
        { name: 'Temporary9', left: 1070, top: 900 },
        { name: 'Temporary10', left: 1070, top: 950 },
        { name: 'Temporary11', left: 1070, top: 1000 },
        { name: 'Temporary12', left: 1070, top: 1050 },
        { name: 'Temporary13', left: 1070, top: 1100 },
        { name: 'Temporary14', left: 1070, top: 1150 }
      ],
      dropZones: [
        { id: "SHIPPED", name: "SHIPPED", left: 1300, top: 1100, width: 160, height: 80, color: '#e74c3c' },
        { id: "TO-8412-OFFICE", name: "TO 8412 OFFICE", left: 1300, top: 950, width: 160, height: 80, color: '#2980b9' }
      ]
    };

    // --- Pallet Class ---
    class Pallet {
      constructor(id, itemId, quantity, location) {
        this.id = id;
        this.itemId = itemId;
        this.quantity = quantity;
        this.location = location || "New_#";

        this.el = document.createElement('div');
        this.el.className = 'pallet';
        this.el.setAttribute('draggable', 'true');
        this.el.dataset.id = id;
        this.el.dataset.itemId = itemId;
        this.el.dataset.quantity = quantity;
        this.el.dataset.location = this.location;

        this.splitArrow = document.createElement('div');
        this.splitArrow.className = 'split-arrow';
        this.splitArrow.innerHTML = 'â—®';
        this.el.appendChild(this.splitArrow);

        this.updateText();
        this.addEventListeners();
      }

      updateText() {
        this.el.innerHTML = `${this.itemId}<br>Q: ${this.quantity}`;
        this.el.appendChild(this.splitArrow);
      }

      addEventListeners() {
      this.el.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', this.id);
        this.el.style.zIndex = '1000';
        this.el.style.pointerEvents = 'none';
      });
    
      this.el.addEventListener('dragend', e => {
        this.el.style.zIndex = '';
        this.el.style.pointerEvents = '';
    
        const container = document.querySelector('.grid-stack');
        const containerRect = container.getBoundingClientRect();
        const dropX = e.clientX - containerRect.left;
        const dropY = e.clientY - containerRect.top;
    
        const nearestLocation = findLocationUnder(e.clientX, e.clientY);
        if (nearestLocation) {
          this.moveToLocation(nearestLocation);
        }
        adjustPalletSizesAtLocation(this.location);
      });
    
      this.splitArrow.addEventListener('click', e => {
        e.stopPropagation();
        const splitQ = prompt(`Enter quantity to split from "${this.itemId}" (max ${this.quantity - 1}):`, Math.floor(this.quantity / 2));
        const num = parseInt(splitQ);
        if (!isNaN(num) && num > 0 && num < this.quantity) {
          this.quantity -= num;
          this.updateText();
          const newPallet = createNewPallet(this.itemId, num, this.location);
          pallets.push(newPallet);
          adjustPalletSizesAtLocation(this.location);
        }
      });
    }

      moveToLocation(newLoc) {
        if(newLoc === this.location) return;
        
        if (palletsByLocation[this.location]) {
          palletsByLocation[this.location] = palletsByLocation[this.location].filter(p => p !== this);
          if(palletsByLocation[this.location].length === 0) delete palletsByLocation[this.location];
        }
        
        if (!palletsByLocation[newLoc]) palletsByLocation[newLoc] = [];
        palletsByLocation[newLoc].push(this);

        this.prevLocation = this.location;
        this.location = newLoc;
        this.el.dataset.location = newLoc;

        positionPalletInLocation(this);

        if (newLoc === 'SHIPPED' || newLoc === 'TO 8412 OFFICE') {
          this.remove();
          pallets = pallets.filter(p => p !== this);
          updateInventorySummary();
          adjustPalletSizesAtLocation(newLoc);
          adjustPalletSizesAtLocation(this.prevLocation);
        }
      }

      remove() {
        if(this.el.parentNode) this.el.parentNode.removeChild(this.el);
      }
    }

    // --- Core Warehouse Functions ---
    function createGridLabels() {
      const container = document.querySelector('.grid-stack');
      // Main grid A1-X11 on left side
      const rows = locations.gridLabels.rows;
      for(let r = 0; r < rows.length; r++) {
        for(let c = 1; c <= locations.gridLabels.cols; c++) {
          const div = document.createElement('div');
          div.className = 'label-cell';
          div.style.left = `${c * CELL_WIDTH}px`;
          div.style.top = `${r * CELL_HEIGHT}px`;
          div.style.width = `${CELL_WIDTH}px`;
          div.style.height = `${CELL_HEIGHT}px`;
          div.innerText = `${rows[r]}${c}`;
          div.dataset.location = `${rows[r]}${c}`;
          container.appendChild(div);
        }
      }
      // Offices top right
      const off = locations.offices;
      for(let i = 1; i <= off.count; i++) {
        const col = i % off.cols;
        const row = Math.floor((i - 1) / off.cols);
        const div = document.createElement('div');
        div.className = 'label-cell office-zone';
        div.style.left = `${off.startLeft + col * off.cellWidth}px`;
        div.style.top = `${off.startTop + row * off.cellHeight}px`;
        div.style.width = `${off.cellWidth}px`;
        div.style.height = `${off.cellHeight}px`;
        div.innerText = `Office${i}`;
        div.dataset.location = `Office${i}`;
        container.appendChild(div);
      }
      // Restrooms, shelves, temporary middle right
      locations.restroomsShelvesTemp.forEach(item => {
        const div = document.createElement('div');
        div.className = 'label-cell restroom-zone';
        div.style.left = `${item.left}px`;
        div.style.top = `${item.top}px`;
        div.style.width = `${item.width || CELL_WIDTH}px`;
        div.style.height = `${item.height || CELL_HEIGHT}px`;
        div.innerText = item.name;
        div.dataset.location = item.name;
        container.appendChild(div);
      });
      // Drop zones bottom right
      locations.dropZones.forEach(zone => {
        const div = document.createElement('div');
        div.className = 'label-cell drop-zone';
        div.id = zone.id;
        div.style.left = `${zone.left}px`;
        div.style.top = `${zone.top}px`;
        div.style.width = `${zone.width}px`;
        div.style.height = `${zone.height}px`;
        div.style.backgroundColor = zone.color;
        div.innerText = zone.name;
        div.dataset.location = zone.name;
        container.appendChild(div);
        makeDropZoneDroppable(div);
      });
    }

    function findLocationUnder(x, y) {
      const container = document.querySelector('.grid-stack');
      const containerRect = container.getBoundingClientRect();
      
      // Convert mouse coordinates to container coordinates
      const relX = x - containerRect.left;
      const relY = y - containerRect.top;
      
      // Get all location elements
      const locElements = document.querySelectorAll('.label-cell');
      let closestElement = null;
      let closestDistance = Infinity;
    
      locElements.forEach(el => {
        const elRect = el.getBoundingClientRect();
        const elX = elRect.left - containerRect.left;
        const elY = elRect.top - containerRect.top;
        
        // Check if coordinates are within this element
        if (relX >= elX && relX <= elX + elRect.width &&
            relY >= elY && relY <= elY + elRect.height) {
          closestElement = el;
          return; // Found exact match, exit early
        }
        
        // Calculate distance to center for fallback
        const centerX = elX + elRect.width/2;
        const centerY = elY + elRect.height/2;
        const distance = Math.sqrt(
          Math.pow(relX - centerX, 2) + 
          Math.pow(relY - centerY, 2)
        );
        
        if (distance < closestDistance) {
          closestDistance = distance;
          closestElement = el;
        }
      });
    
      return closestElement ? closestElement.dataset.location : null;
    }
    function createNewPallet(itemId, quantity, location = "New_#") {
      const id = 'pallet-' + Date.now() + '-' + Math.floor(Math.random()*1000);
      const pallet = new Pallet(id, itemId, quantity, location);

      document.querySelector('.grid-stack').appendChild(pallet.el);
      pallets.push(pallet);

      if(!palletsByLocation[location]) palletsByLocation[location] = [];
      palletsByLocation[location].push(pallet);

      positionPalletInLocation(pallet);
      adjustPalletSizesAtLocation(location);

      return pallet;
    }

    function positionPalletInLocation(pallet) {
      const location = pallet.location;
      let locEl = null;
      
      if(location === "SHIPPED" || location === "TO 8412 OFFICE") {
        locEl = document.getElementById(location.replace(/\s/g, '-'));
      } else {
        locEl = Array.from(document.querySelectorAll('.label-cell'))
          .find(el => el.dataset.location === location);
      }
      if(!locEl) return;

      const left = parseInt(locEl.style.left);
      const top = parseInt(locEl.style.top);
      const width = parseInt(locEl.style.width);
      const height = parseInt(locEl.style.height);

      const stack = palletsByLocation[location] || [];
      const idx = stack.indexOf(pallet);
      const total = stack.length;

      const palletWidth = width;
      const palletHeight = Math.floor(height / total);

      pallet.el.style.left = left + 'px';
      pallet.el.style.top = (top + palletHeight * idx) + 'px';
      pallet.el.style.width = palletWidth + 'px';
      pallet.el.style.height = palletHeight + 'px';
    }

    function adjustPalletSizesAtLocation(location) {
      if(!location) return;
      const stack = palletsByLocation[location];
      if (!stack) return;
      stack.forEach(p => positionPalletInLocation(p));
    }

    function makeDropZoneDroppable(zoneEl) {
      zoneEl.addEventListener('dragover', e => {
        e.preventDefault();
        zoneEl.style.outline = '2px dashed #fff';
      });
      zoneEl.addEventListener('dragleave', e => {
        zoneEl.style.outline = '';
      });
      zoneEl.addEventListener('drop', e => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain');
        const pallet = pallets.find(p => p.id === id);
        if(pallet) {
          pallet.moveToLocation(zoneEl.dataset.location);
        }
        zoneEl.style.outline = '';
      });
    }

    function updateInventorySummary() {
      const summary = {};
      pallets.forEach(p => {
        if(p.location !== 'SHIPPED' && p.location !== 'TO 8412 OFFICE') {
          summary[p.itemId] = (summary[p.itemId] || 0) + p.quantity;
        }
      });
      const out = document.getElementById('inventory-summary-output');
      out.innerHTML = '';
      for(let key in summary) {
        out.innerHTML += `${key}: ${summary[key]}<br>`;
      }
    }

    // --- Firebase Functions ---
    // Load shared warehouse data (live updates)
// Load shared warehouse data (live updates)
  function loadWarehouseData() {
    document.getElementById('loading-indicator').style.display = 'flex';
    
    const ref = database.ref('warehouse/pallets');
    ref.on('value', (snapshot) => {
      const data = snapshot.val();
      document.getElementById('loading-indicator').style.display = 'none';
      
      if (data) {
        // Only update if data actually changed
        const dataString = JSON.stringify(data);
        if (dataString !== this.lastDataString) {
          this.lastDataString = dataString;
          
          // Clear existing pallets
          pallets.forEach(p => p.remove());
          pallets = [];
          palletsByLocation = {};
          
          // Recreate pallets from shared data
          Object.values(data).forEach(palletData => {
            createNewPallet(palletData.itemId, palletData.quantity, palletData.location);
          });
        }
      }
    }, (error) => {
      console.error("Error loading data:", error);
      document.getElementById('loading-indicator').style.display = 'none';
      alert("Error loading warehouse data");
    });
  }
    // Save changes to shared warehouse
     function saveWarehouseData() {
      // Only save if there are actual changes
      const newData = {};
      pallets.forEach(p => {
        newData[p.id] = {
          itemId: p.itemId,
          quantity: p.quantity,
          location: p.location
        };
      });
      
      const newDataString = JSON.stringify(newData);
      if (newDataString !== this.lastSavedData) {
        this.lastSavedData = newDataString;
        database.ref('warehouse/pallets').set(newData)
          .catch(error => console.error("Save error:", error));
      }
    }


    // --- Event Listeners ---
    function setupEventListeners() {
      document.getElementById('add-product-btn').addEventListener('click', () => {
        const itemId = document.getElementById('new-item').value.trim();
        const q = parseInt(document.getElementById('new-q').value);
        if(!itemId || isNaN(q) || q < 1) {
          alert("Enter valid Item ID and Quantity");
          return;
        }
        createNewPallet(itemId, q, 'New_#');
        document.getElementById('new-item').value = '';
        document.getElementById('new-q').value = '';
      });

      document.getElementById('inventory-summary-panel').addEventListener('click', () => {
        updateInventorySummary();
        const output = document.getElementById('inventory-summary-output');
        output.style.display = output.style.display === 'none' ? 'block' : 'none';
      });
    }

    // --- Authentication ---
    function initAuth() {
      firebase.auth().onAuthStateChanged(user => {
        if (user) {
          // User is signed in
          document.getElementById('login-container').style.display = 'none';
          document.getElementById('warehouse-app').style.display = 'block';
          document.getElementById('logout-btn').style.display = 'block';
          loadWarehouseData(user.uid);
          initWarehouseApp();
        } else {
          // No user is signed in
          document.getElementById('login-container').style.display = 'flex';
          document.getElementById('warehouse-app').style.display = 'none';
          document.getElementById('logout-btn').style.display = 'none';
        }
      });
    }

    function initWarehouseApp() {
      createGridLabels();
      setupEventListeners();
      
      // Auto-save every 30 seconds
      setInterval(() => {
        const user = firebase.auth().currentUser;
        if (user) saveWarehouseData(user.uid);
      }, 30000);
    }

    // --- Initialize App ---
    window.onload = function() {
      // Set up login/logout
      document.getElementById('login-btn').addEventListener('click', () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        firebase.auth().signInWithEmailAndPassword(email, password)
          .catch(error => alert(error.message));
      });

      document.getElementById('logout-btn').addEventListener('click', () => {
        firebase.auth().signOut();
      });

      // Initialize authentication
      initAuth();
    };
  </script>
</body>
</html>
