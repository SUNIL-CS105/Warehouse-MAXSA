<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MAXSA Warehouse Map with Resizable Pallets</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:1rem; overflow-x: hidden; }
        h2 { margin-top: 0; }
        #warehouse-container {
            position: absolute;
            width: 1730px;
            height: 1350px;
            transform-origin: top left;
        }
        .grid-stack {
            position: absolute;
            width: 1730px;
            height: 1350px;
            background: #ADD8E6;
            border: 2px solid #000000;
            user-select: none;
            touch-action: none;
            transform-origin: top left;
        }
        .label-cell {
            position: absolute;
            border: 1px solid #000000;
            text-align: center;
            padding: 5px;
            font-size: 12px;
            background-color: #FFFFFF;
            box-sizing: border-box;
        }
        .office-zone, .restroom-zone, .drop-zone, .history-panel {
            font-weight: bold;
        }
        .office-zone {
            background-color: #FFFFFF;
        }
        .restroom-zone {
            background-color: #FFFFFF;
        }
        .drop-zone {
            border: 2px dashed white;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            cursor: default;
        }
        .drop-zone#SHIPPED {
            background-color: #e74c3c;
        }
        .drop-zone#TO-8412-OFFICE {
            background-color: #2980b9;
        }
        .pallet {
            position: absolute;
            background: orange;
            color: black;
            font-weight: bold;
            border: 2px solid #000000;
            text-align: center;
            cursor: grab;
            user-select: none;
            box-sizing: border-box;
            padding: 4px 2px 10px 2px;
            font-size: 12px;
            white-space: pre-line;
            transition: transform 0.2s ease-out;
        }
        .pallet.dragging {
            opacity: 0.6;
            cursor: grabbing;
            z-index: 1000;
        }
        .split-arrow {
            position: absolute;
            top: 2px;
            right: 4px;
            background: black;
            color: white;
            font-weight: bold;
            font-size: 14px;
            width: 18px;
            height: 18px;
            line-height: 18px;
            border-radius: 3px;
            cursor: pointer;
            user-select: none;
            z-index: 10;
        }
        .control-panel {
            position: absolute;
            background: #27ae60;
            padding: 10px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            width: 200px;
            box-sizing: border-box;
            transform-origin: top left;
        }
        #add-product-panel {
            top: 650px;
            left: 990px;
            background: #27ae60;
            z-index: 100;
        }
        #add-product-panel input {
            width: calc(100% - 12px);
            margin-bottom: 6px;
            padding: 5px;
            border: none;
            border-radius: 3px;
            font-size: 14px;
        }
        #add-product-panel input::placeholder {
            color: #bbb;
        }
        #add-product-panel button {
            width: 100%;
            padding: 6px;
            font-weight: bold;
            font-size: 14px;
            background: #2ecc71;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            color: white;
        }
        #add-product-panel button:hover {
            background: #27ae60;
        }
        #inventory-summary-panel {
            top: 80px;
            left: 1480px;
            background: #3498db;
            width: 220px;
            font-size: 14px;
            cursor: pointer;
            text-align: center;
            user-select: none;
        }
        #inventory-summary-output {
            max-height: 120px;
            overflow-y: auto;
            margin-top: 6px;
            font-weight: normal;
            font-size: 13px;
            background: rgba(255 255 255 / 0.2);
            padding: 6px;
            border-radius: 4px;
            text-align: left;
            white-space: nowrap;
        }
        #history-panel {
            top: 790px;
            left: 1300px;
            background: #f1c40f;
            width: 160px;
            text-align: center;
        }
        .history-icons {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
        }
        .history-icon-btn {
            background: #f39c12;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            border: 2px solid white;
        }
        .history-icon-btn.new-product { background: #2ecc71; }
        .history-icon-btn.shipped { background: #e74c3c; }
        .history-icon-btn.office { background: #2980b9; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1003;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        #history-output {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #eee;
            font-size: 14px;
        }
        /* Login styles */
        #login-container, #signup-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box {
            background: #f5f5f5;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            width: 300px;
            text-align: center;
        }
        .login-box input {
            width: 100%;
            padding: 0.5rem;
            margin: 0.5rem 0;
            box-sizing: border-box;
        }
        .login-box button {
            width: 100%;
            padding: 0.5rem;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 1rem;
        }
        .login-box a {
            font-size: 12px;
            color: #3498db;
            cursor: pointer;
            display: block;
            margin-top: 10px;
        }
        #logout-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 0.5rem 1rem;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none;
            z-index: 1001;
        }
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 1002;
            display: none;
        }
    </style>
</head>
<body>
    <div id="login-container">
        <div class="login-box">
            <h2>Warehouse Login</h2>
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button id="login-btn">Login</button>
            <a id="show-signup">New User? Sign Up</a>
        </div>
    </div>

    <div id="signup-container" style="display:none;">
        <div class="login-box">
            <h2>Warehouse Sign Up</h2>
            <input type="email" id="signup-email" placeholder="Email">
            <input type="password" id="signup-password" placeholder="Password">
            <button id="signup-btn">Sign Up</button>
            <a id="show-login">Already have an account? Login</a>
        </div>
    </div>

    <div id="loading-indicator">Loading warehouse data...</div>

    <button id="logout-btn">Logout</button>

    <div id="warehouse-app" style="display:none;">
        <h2>MAXSA Warehouse Map</h2>
        <div id="warehouse-container">
            <div class="grid-stack"></div>

            <div id="add-product-panel" class="control-panel">
                <input type="text" id="new-item" placeholder="Item #" />
                <input type="number" id="new-q" placeholder="Quantity" min="1" />
                <button id="add-product-btn">‚ûï Add New Product</button>
            </div>

            <div id="inventory-summary-panel" class="control-panel" title="Show total quantities of all products (excluding shipped and To 8412 Office)">
                üìä Show Inventory Summary
                <div id="inventory-summary-output" style="display:none;"></div>
            </div>

            <div id="history-panel" class="control-panel">
                History
                <div class="history-icons">
                    <div class="history-icon-btn new-product" data-type="new-product" title="New Products">üì¶</div>
                    <div class="history-icon-btn shipped" data-type="shipped" title="Shipped Products">üöö</div>
                    <div class="history-icon-btn office" data-type="to-office" title="To Office Products">üè¢</div>
                </div>
            </div>
        </div>
        
        <div id="history-modal" class="modal">
            <div class="modal-content">
                <span class="close-btn">&times;</span>
                <h3 id="history-modal-title">History Log</h3>
                <div id="history-output"></div>
            </div>
        </div>
    </div>

    <script>
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDgTBFlnjtcbdvuf2l7YUnoHXK9-L4I5MI",
            authDomain: "warehouse-maxsa.firebaseapp.com",
            databaseURL: "https://warehouse-maxsa-default-rtdb.firebaseio.com",
            projectId: "warehouse-maxsa",
            storageBucket: "warehouse-maxsa.firebasestorage.app",
            messagingSenderId: "978214247804",
            appId: "1:978214247804:web:aa785914ee177d74ba98f9"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // --- Warehouse App Variables ---
        const CELL_WIDTH = 80;
        const CELL_HEIGHT = 50;
        let pallets = [];
        let palletsByLocation = {};
        let scale = 1.0;
        let isDraggingPallet = false;

        // Location definitions
        const locations = {
            gridLabels: {
                rows: ['X','W','V','U','T','S','R','Q','P','O','N','M','L','K','J','I','H','G','F','E','D','C','B','A'],
                cols: 11
            },
            offices: {
                count: 30,
                startLeft: 980,
                startTop: 0,
                cols: 6,
                cellWidth: 80,
                cellHeight: 50
            },
            restroomsShelvesTemp: [
                { name: 'Restroom1', left: 980, top: 300 },
                { name: 'Restroom2', left: 1060, top: 300 },
                { name: 'Shelf1', left: 1220, top: 300 },
                { name: 'Shelf2', left: 1300, top: 300 },
                { name: 'Shelf3', left: 1380, top: 300 },
                { name: 'Shelf4', left: 1220, top: 350 },
                { name: 'Shelf5', left: 1300, top: 350 },
                { name: 'Shelf6', left: 1380, top: 350 },
                { name: 'New_#', left: 990, top: 500, width: 160, height: 80, color: '#FFFFFF' },
                { name: 'Temporary1', left: 980, top: 850 },
                { name: 'Temporary2', left: 980, top: 900 },
                { name: 'Temporary3', left: 980, top: 950 },
                { name: 'Temporary4', left: 980, top: 1000 },
                { name: 'Temporary5', left: 980, top: 1050 },
                { name: 'Temporary6', left: 980, top: 1100 },
                { name: 'Temporary7', left: 980, top: 1150 },
                { name: 'Temporary8', left: 1070, top: 850 },
                { name: 'Temporary9', left: 1070, top: 900 },
                { name: 'Temporary10', left: 1070, top: 950 },
                { name: 'Temporary11', left: 1070, top: 1000 },
                { name: 'Temporary12', left: 1070, top: 1050 },
                { name: 'Temporary13', left: 1070, top: 1100 },
                { name: 'Temporary14', left: 1070, top: 1150 }
            ],
            dropZones: [
                { id: "SHIPPED", name: "SHIPPED", left: 1300, top: 1100, width: 160, height: 80, color: '#e74c3c' },
                { id: "TO-8412-OFFICE", name: "TO 8412 OFFICE", left: 1300, top: 950, width: 160, height: 80, color: '#2980b9' }
            ]
        };

        // --- Pallet Class ---
        class Pallet {
            constructor(id, itemId, quantity, location) {
                this.id = id;
                this.itemId = itemId;
                this.quantity = quantity;
                this.location = location || "New_#";

                this.el = document.createElement('div');
                this.el.className = 'pallet';
                this.el.setAttribute('draggable', 'true');
                this.el.dataset.id = id;
                this.el.dataset.itemId = itemId;
                this.el.dataset.quantity = quantity;
                this.el.dataset.location = this.location;

                this.splitArrow = document.createElement('div');
                this.splitArrow.className = 'split-arrow';
                this.splitArrow.innerHTML = '‚óÆ';
                this.el.appendChild(this.splitArrow);

                this.updateText();
                this.addEventListeners();
            }

            updateText() {
                this.el.innerHTML = `${this.itemId}<br>Q: ${this.quantity}`;
                this.el.appendChild(this.splitArrow);
            }

            addEventListeners() {
                this.el.addEventListener('dragstart', e => {
                    e.dataTransfer.setData('text/plain', this.id);
                    e.dataTransfer.effectAllowed = "move";
                    this.el.classList.add('dragging');
                    isDraggingPallet = true;
                });

                this.el.addEventListener('dragend', e => {
                    this.el.classList.remove('dragging');
                    isDraggingPallet = false;
                    const dropX = e.clientX;
                    const dropY = e.clientY;
                    const nearestLocation = findLocationUnder(dropX, dropY);
                    if (nearestLocation) {
                        this.moveToLocation(nearestLocation);
                    }
                });

                this.el.addEventListener('touchstart', e => {
                    const touch = e.touches[0];
                    const palletRect = this.el.getBoundingClientRect();
                    this.offsetX = touch.clientX - palletRect.left;
                    this.offsetY = touch.clientY - palletRect.top;

                    this.el.style.position = 'absolute';
                    this.el.style.zIndex = 1000;
                    this.el.classList.add('dragging');
                    isDraggingPallet = true;
                    e.preventDefault();
                });

                this.el.addEventListener('touchmove', e => {
                    if (isDraggingPallet) {
                        const touch = e.touches[0];
                        const container = document.querySelector('.grid-stack');
                        const containerRect = container.getBoundingClientRect();

                        let newLeft = (touch.clientX - containerRect.left - this.offsetX) / scale;
                        let newTop = (touch.clientY - containerRect.top - this.offsetY) / scale;

                        this.el.style.left = `${newLeft}px`;
                        this.el.style.top = `${newTop}px`;
                        e.preventDefault();
                    }
                });

                this.el.addEventListener('touchend', e => {
                    if (isDraggingPallet) {
                        const touch = e.changedTouches[0];
                        const dropX = touch.clientX;
                        const dropY = touch.clientY;
                        const nearestLocation = findLocationUnder(dropX, dropY);
                        if (nearestLocation) {
                            this.moveToLocation(nearestLocation);
                        }
                        this.el.classList.remove('dragging');
                        isDraggingPallet = false;
                        e.preventDefault();
                    }
                });

                this.splitArrow.addEventListener('click', e => {
                    e.stopPropagation();
                    const splitQ = prompt(`Enter quantity to split from "${this.itemId}" (max ${this.quantity - 1}):`, Math.floor(this.quantity / 2));
                    const num = parseInt(splitQ);
                    if (!isNaN(num) && num > 0 && num < this.quantity) {
                        this.quantity -= num;
                        this.updateText();
                        const newPallet = createNewPallet(this.itemId, num, this.location, false);
                        pallets.push(newPallet);
                        saveWarehouseData();
                        adjustPalletSizesAtLocation(this.location);
                    }
                });
            }

            moveToLocation(newLoc) {
                const oldLoc = this.location;
                if (newLoc === oldLoc) return;

                if (palletsByLocation[oldLoc]) {
                    palletsByLocation[oldLoc] = palletsByLocation[oldLoc].filter(p => p !== this);
                    if (palletsByLocation[oldLoc].length === 0) delete palletsByLocation[oldLoc];
                }

                if (!palletsByLocation[newLoc]) palletsByLocation[newLoc] = [];
                palletsByLocation[newLoc].push(this);

                this.location = newLoc;
                this.el.dataset.location = newLoc;

                if (newLoc === 'SHIPPED' || newLoc === 'TO 8412 OFFICE') {
                    recordHistory(newLoc, this.itemId, this.quantity);
                    this.remove();
                    pallets = pallets.filter(p => p !== this);
                    updateInventorySummary();
                } else {
                    positionPalletInLocation(this);
                }

                saveWarehouseData();
                adjustPalletSizesAtLocation(oldLoc);
                adjustPalletSizesAtLocation(newLoc);
            }

            remove() {
                if(this.el.parentNode) this.el.parentNode.removeChild(this.el);
            }
        }

        // --- Core Warehouse Functions ---
        function createGridLabels() {
            const container = document.querySelector('.grid-stack');
            container.innerHTML = '';

            const rows = locations.gridLabels.rows;
            for(let r = 0; r < rows.length; r++) {
                for(let c = 1; c <= locations.gridLabels.cols; c++) {
                    const div = document.createElement('div');
                    div.className = 'label-cell';
                    div.style.left = `${c * CELL_WIDTH}px`;
                    div.style.top = `${r * CELL_HEIGHT}px`;
                    div.style.width = `${CELL_WIDTH}px`;
                    div.style.height = `${CELL_HEIGHT}px`;
                    div.innerText = `${rows[r]}${c}`;
                    div.dataset.location = `${rows[r]}${c}`;
                    container.appendChild(div);
                }
            }
            const off = locations.offices;
            for(let i = 1; i <= off.count; i++) {
                const col = i % off.cols;
                const row = Math.floor((i - 1) / off.cols);
                const div = document.createElement('div');
                div.className = 'label-cell office-zone';
                div.style.left = `${off.startLeft + col * off.cellWidth}px`;
                div.style.top = `${off.startTop + row * off.cellHeight}px`;
                div.style.width = `${off.cellWidth}px`;
                div.style.height = `${off.cellHeight}px`;
                div.innerText = `Office${i}`;
                div.dataset.location = `Office${i}`;
                container.appendChild(div);
            }
            locations.restroomsShelvesTemp.forEach(item => {
                const div = document.createElement('div');
                div.className = 'label-cell restroom-zone';
                div.style.left = `${item.left}px`;
                div.style.top = `${item.top}px`;
                div.style.width = `${item.width || CELL_WIDTH}px`;
                div.style.height = `${item.height || CELL_HEIGHT}px`;
                div.innerText = item.name;
                div.dataset.location = item.name;
                container.appendChild(div);
            });
            locations.dropZones.forEach(zone => {
                const div = document.createElement('div');
                div.className = 'label-cell drop-zone';
                div.id = zone.id;
                div.style.left = `${zone.left}px`;
                div.style.top = `${zone.top}px`;
                div.style.width = `${zone.width}px`;
                div.style.height = `${zone.height}px`;
                div.style.backgroundColor = zone.color;
                div.innerText = zone.name;
                div.dataset.location = zone.name;
                container.appendChild(div);
            });
        }

        function findLocationUnder(x, y) {
            const container = document.querySelector('.grid-stack');
            const containerRect = container.getBoundingClientRect();
            const relX = x - containerRect.left;
            const relY = y - containerRect.top;

            let found = null;
            let minDist = Infinity;

            document.querySelectorAll('.label-cell').forEach(el => {
                const elRect = el.getBoundingClientRect();
                const elX = elRect.left + elRect.width / 2;
                const elY = elRect.top + elRect.height / 2;
                const dx = x - elX;
                const dy = y - elY;
                const dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < minDist) {
                    minDist = dist;
                    found = el.dataset.location;
                }
            });
            return found;
        }

        function createNewPallet(itemId, quantity, location = "New_#", record = true) {
            const id = 'pallet-' + Date.now() + '-' + Math.floor(Math.random()*1000);
            const pallet = new Pallet(id, itemId, quantity, location);

            document.querySelector('.grid-stack').appendChild(pallet.el);
            pallets.push(pallet);

            if(!palletsByLocation[location]) palletsByLocation[location] = [];
            palletsByLocation[location].push(pallet);

            positionPalletInLocation(pallet);
            adjustPalletSizesAtLocation(location);

            if(record) {
                recordHistory('new-product', itemId, quantity);
                saveWarehouseData();
            }
            return pallet;
        }

        function positionPalletInLocation(pallet) {
            const location = pallet.location;
            let locEl = Array.from(document.querySelectorAll('.label-cell')).find(el => el.dataset.location === location);
            
            if(!locEl) return;

            const left = parseInt(locEl.style.left);
            const top = parseInt(locEl.style.top);
            const width = parseInt(locEl.style.width);
            const height = parseInt(locEl.style.height);

            const stack = palletsByLocation[location] || [];
            const idx = stack.indexOf(pallet);
            const total = stack.length;

            const palletWidth = width;
            const palletHeight = total > 0 ? Math.floor(height / total) : height;

            pallet.el.style.left = left + 'px';
            pallet.el.style.top = (top + palletHeight * idx) + 'px';
            pallet.el.style.width = palletWidth + 'px';
            pallet.el.style.height = palletHeight + 'px';
        }

        function adjustPalletSizesAtLocation(location) {
            if(!location) return;
            const stack = palletsByLocation[location];
            if (!stack) return;
            stack.forEach(p => positionPalletInLocation(p));
        }

        function updateInventorySummary() {
            const summary = {};
            pallets.forEach(p => {
                if(p.location !== 'SHIPPED' && p.location !== 'TO 8412 OFFICE') {
                    summary[p.itemId] = (summary[p.itemId] || 0) + p.quantity;
                }
            });
            const out = document.getElementById('inventory-summary-output');
            out.innerHTML = '';
            for(let key in summary) {
                out.innerHTML += `<b>${key}</b>: ${summary[key]}<br>`;
            }
        }

        // --- Firebase Functions ---
        function loadWarehouseData() {
            const ref = database.ref('warehouse/pallets');
            ref.on('value', (snapshot) => {
                const data = snapshot.val();
                pallets.forEach(p => p.remove());
                pallets = [];
                palletsByLocation = {};
                
                if (data) {
                    Object.values(data).forEach(palletData => {
                        createNewPallet(palletData.itemId, palletData.quantity, palletData.location, false);
                    });
                }
                updateInventorySummary();
            });
        }
        
        function saveWarehouseData() {
            const data = {};
            pallets.forEach(p => {
                data[p.id] = {
                    itemId: p.itemId,
                    quantity: p.quantity,
                    location: p.location
                };
            });
            database.ref('warehouse/pallets').set(data);
        }

        function recordHistory(type, itemId, quantity) {
            const user = firebase.auth().currentUser;
            if (!user) return;
            const historyRef = database.ref(`users/${user.uid}/history`).push();
            historyRef.set({
                type: type,
                itemId: itemId,
                quantity: quantity,
                timestamp: Date.now()
            });
        }

        function showHistory(type) {
            const user = firebase.auth().currentUser;
            if (!user) return;

            const modalTitle = document.getElementById('history-modal-title');
            const historyOutput = document.getElementById('history-output');
            historyOutput.innerHTML = 'Loading...';
            
            const historyRef = database.ref(`users/${user.uid}/history`).orderByChild('timestamp');
            historyRef.on('value', (snapshot) => {
                const data = snapshot.val();
                historyOutput.innerHTML = '';
                if (!data) {
                    historyOutput.innerHTML = 'No history found.';
                    return;
                }

                let entries = Object.values(data).filter(entry => {
                    if (type === 'new-product') return entry.type === 'new-product';
                    if (type === 'shipped') return entry.type === 'SHIPPED';
                    if (type === 'to-office') return entry.type === 'TO 8412 OFFICE';
                    return false;
                }).reverse();
                
                modalTitle.innerText = `${type.replace(/-/g, ' ').toUpperCase()} History`;

                if (entries.length > 0) {
                    entries.forEach(entry => {
                        const date = new Date(entry.timestamp).toLocaleString();
                        historyOutput.innerHTML += `<b>${date}</b>: ${entry.itemId} (Q: ${entry.quantity})<br>`;
                    });
                } else {
                    historyOutput.innerHTML = `No history for this category.`;
                }
                document.getElementById('history-modal').style.display = 'block';
            });
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('add-product-btn').addEventListener('click', () => {
                const itemId = document.getElementById('new-item').value.trim();
                const q = parseInt(document.getElementById('new-q').value);
                if(!itemId || isNaN(q) || q < 1) {
                    alert("Enter valid Item ID and Quantity");
                    return;
                }
                createNewPallet(itemId, q, 'New_#');
                document.getElementById('new-item').value = '';
                document.getElementById('new-q').value = '';
            });

            document.getElementById('inventory-summary-panel').addEventListener('click', () => {
                updateInventorySummary();
                const output = document.getElementById('inventory-summary-output');
                output.style.display = output.style.display === 'none' ? 'block' : 'none';
            });
            
            document.querySelectorAll('.history-icon-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const type = btn.dataset.type;
                    showHistory(type);
                });
            });

            document.querySelector('#history-modal .close-btn').addEventListener('click', () => {
                document.getElementById('history-modal').style.display = 'none';
            });

            window.addEventListener('click', e => {
                if (e.target === document.getElementById('history-modal')) {
                    document.getElementById('history-modal').style.display = 'none';
                }
            });

            window.addEventListener('resize', scaleGrid);
            function scaleGrid() {
            const parent = document.querySelector('#warehouse-app');
            const container = document.querySelector('#warehouse-container');
            const screenWidth = parent.clientWidth;
            const screenHeight = parent.clientHeight;
            
            const originalWidth = 1730;
            const originalHeight = 1350;
        
            const scale = Math.min(screenWidth / originalWidth, screenHeight / originalHeight, 1);
            
            // Apply the scale to the main container
            container.style.transform = `scale(${scale})`;
            
            // Center the container horizontally
            container.style.left = `${(screenWidth - originalWidth * scale) / 2}px`;
            }

            scaleGrid();
        }

        // --- Authentication ---
        function initAuth() {
            firebase.auth().onAuthStateChanged(user => {
                if (user) {
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('signup-container').style.display = 'none';
                    document.getElementById('warehouse-app').style.display = 'block';
                    document.getElementById('logout-btn').style.display = 'block';
                    loadWarehouseData();
                    initWarehouseApp();
                } else {
                    document.getElementById('login-container').style.display = 'flex';
                    document.getElementById('signup-container').style.display = 'none';
                    document.getElementById('warehouse-app').style.display = 'none';
                    document.getElementById('logout-btn').style.display = 'none';
                }
            });
        }

        function initWarehouseApp() {
            createGridLabels();
            setupEventListeners();
            
            setInterval(() => {
                const user = firebase.auth().currentUser;
                if (user) saveWarehouseData();
            }, 30000);
        }

        // --- Initialize App ---
        window.onload = function() {
            document.getElementById('login-btn').addEventListener('click', () => {
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .catch(error => alert(error.message));
            });

            document.getElementById('logout-btn').addEventListener('click', () => {
                firebase.auth().signOut();
            });

            document.getElementById('show-signup').addEventListener('click', () => {
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('signup-container').style.display = 'flex';
            });

            document.getElementById('show-login').addEventListener('click', () => {
                document.getElementById('signup-container').style.display = 'none';
                document.getElementById('login-container').style.display = 'flex';
            });

            document.getElementById('signup-btn').addEventListener('click', () => {
                const email = document.getElementById('signup-email').value;
                const password = document.getElementById('signup-password').value;
                firebase.auth().createUserWithEmailAndPassword(email, password)
                    .then(userCredential => {
                        const user = userCredential.user;
                        alert("Sign up successful! You are now logged in.");
                    })
                    .catch(error => alert(error.message));
            });

            initAuth();
        };
    </script>
</body>
</html>
